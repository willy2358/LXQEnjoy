<!--terms: round, trick --->
<game name="shengji">
  
  <!--
    type:类型
    sets:牌副数：默认值：1
  -->
  <cards type="M/P" sets="1">
    <!--去牌
    valid: 节点是否生效，true：生效；false: 无效-->
    <excludes valid="false">
      <!--
      ctype:s|h|d|c|j
            *: 所有类型,默认值，也即，如果card的属性中不包括ctype属性时，ctype取默认值*,所有类型
            -: 未指定
      cfigure: 1 - 13, 21,22
            *：所有数字，默认值，也即，如果card的属性中不包括cfigure属性时，cfigure取默认值*，不限数字
            -: 未指定  
                    
      -->
      <card ctype="-" cfigure="-"/>
    </excludes>

    <!--底牌
        count: 留牌张数
        public_shown: 底牌是否对其他玩家可见：true: 可见；false: 不可见
    -->
    <kitty valid="true" count="6" public_shown="false"/>

    <!--分数牌-->
    <score_cards valid="true">
      <!--
         card 说明 同excludes
      -->
      <card ctype="*" cfigure="5" score="5"/>
      <card ctype="*" cgigure="10" score="10"/>
      <card ctype="*" cfigure="13" score="10"/>
    </score_cards>

    <!--牌型，如有对同一牌型不同的配置，后面的覆盖前面的
        power_range 属性为方便配置参考，无代码执行影响  
       leading 是否可作为起始牌，默认为true, 可以由一圈的起始打牌人打出, false,只能用于跟牌
       由于牌的power由牌的组合方式确定，而牌在打出后组合方式才确定，所以，牌的power在牌打出后，由服务器计算玩家出牌的power.
    -->
    <patterns>    
      <!--单牌-->
      <static_power>    
        <single ctype="*" cfigure="1" power="14"/>
        <single ctype="*" cfigure="2" power="2" />
        <single ctype="*" cfigure="3" power="3" />
        <single ctype="*" cfigure="4" power="4" />
        <single ctype="*" cfigure="5" power="5" />
        <single ctype="*" cfigure="6" power="6" />
        <single ctype="*" cfigure="7" power="7" />
        <single ctype="*" cfigure="8" power="8" />
        <single ctype="*" cfigure="9" power="9" />
        <single ctype="*" cfigure="10" power="10" />
        <single ctype="*" cfigure="11" power="11" />
        <single ctype="*" cfigure="12" power="12" />
        <single ctype="*" cfigure="13" power="13" />

        <single ctype="j" cfigure="21" power="50" power_range="50"/>
        <single ctype="j" cfigure="22" power="51" power_range="51"/>
      </static_power>

      <runtime_power>
        <!--主牌-->
        <single>
          <!--主牌花色牌-->
          <set property="power" value=":((cfigure_of(card)) + 20)" power_range="21-33">
            <case testee="card" ctype_of="card" ret_as=":(round.bank_ctype)"/>
          </set>
          
          <!--主牌数字牌-->
          <set property="power" value="35" >
            <case cfigure_of="card" ret_as=":(round.bank_cfigure)"/>
          </set>
          
          <!--正主牌--> 
          <set property="power" value="36">
            <!--
              多条件判断，test_type: and 与运算，缺省值
                                   or  或运算              
            -->
            <cases testee="card" test_type="and">
              <case ctype_of="card" ret_as=":(round.bank_ctype)"/>
              <case cfigure_of="card" ret_as=":(round.bank_cfigure)"/>
            </cases>
          </set>
        </single>

        <!--四张-->
        <quad testee="cards" name="zha" power=":((max_cfigure_of(cards)) + 5)" range="6-18"/>
        
        <!--四张的跟牌-->
        <comp name="zha_follow" leading="false" params="x,y,z,u">
          <!--非枪毙牌，最小-->
          <set property="power" value="0">
            <case ctype_count_of="cards" ret_not_is="1"/>
          </set>
          
          <!--枪毙牌，大过四张牌, 前提是手中已没有其他花牌-->
          <set property="power" value=":(max_power_of(cards))">
            <cases test_type="and">
              <case ctype_count_of="cards" ret_is="1"/> 
              <case ctype_of="cards[0]" ret_as=":(round.bank_ctype)"/>
            </cases>
          </set>        
        </comp>

        <!--甩牌, 同色，多张-->
        <same_ctype name="shuai" power=":(max_power_of(cards))">
          <set property="leading" value="true">
            <cases>            
              <!--不能有主牌数字-->
              <case cards_contain_cfigure_as=":(round.bank_cfigure)" ret_not_is="true"/> 
              <!--都是大牌-->
              <case min_cfigure_of="cards" ret_gt_as=":(cards_in_other_players_hnad|cards_of_ctype(ctype_of(cards[0]))|max_cfigure)"/>
            </cases> 
          </set>
    
        </same_ctype>

        <!--甩牌跟牌-->
        <comp name="shuai_follow" params="x|y" leading="false">  
          <!--非枪毙牌，最小-->
          <set property="power" value="0">
            <case is_all_ctype_as=":(round.bank_ctype)" ret_not_is="false"/>
          </set>

          <!--枪毙牌，大过四张牌, 前提是手中已没有其他花牌-->
          <set property="power" value=":(max_power_of(cards))">
            <case is_all_ctype_as=":(round.bank_ctype)" ret_not_is="true"/>
          </set> 
        </comp>
      </runtime_power>
    </patterns>
  </cards>

   <round_attrs>
    <round_attr name="cur_level" value_type="int" init_value="2"/>
    <round_attr name="defenders" value_type="list" init_value="none"/>
    <round_attr name="attacters" value_type="list" init_value="none"/>

    <!--庄牌点数-->
    <round_attr name="bank_cfigure" value_type="int" init_value="2"/>

    <!--庄牌花色-->
    <round_attr name="bank_ctype" value_type="string" init_value="none"/>

    <!--起牌玩家，第一个摸牌的人-->
    <round_attr name="init_drawer" value_type="Player" init_value="random"/>

  </round_attrs>

  <!--跟牌规则：
  是否跟牌：
  1. 必须出牌
    牌型要求
      无相同牌型的处理
      与起牌人的牌型相同
      与上家的牌型相同
    牌张要求
  2. 大才出牌

  pattern_ref_as=":(trick_init_player)"
  pattern_ref_as=":(prev_player)"
  --->
  <following must_follow="true" 
             pattern_ref_as=":(trick_init_player)">    
    
    <leading pattern_type="single">
      <case if_ctype_void_as="card">
        <yes>
          <following_cards ctype_as="card" count="1"/>
        </yes>  
        <not>
          <following_cards ctype_of="any" count="1"/>
        </not>
      </case>
    </leading>

    <leading pattern_name="zha">
      <case player_has_cards_of_pattern="zha">
        <yes>
          <following_cards pattern_name="zha"/>
        </yes>
        <not>
          <following_cards>
            <card>
              <case player_has_cards_of_ctype="club">
                <yes>
                  <card_type ctype_of="club"/>
                </yes>
                <not>
                  <card_type ctype_of="any"/>
                </not>       
              </case>
            </card>
            <card>
              <case player_has_cards_of_ctype="diamond">
                <yes>
                  <card_type ctype_of="diamond"/>
                </yes>
                <not>
                  <card_type ctype_of="any"/>
                </not>       
              </case>
            </card>
            <card>
              <case player_has_cards_of_ctype="heart">
                <yes>
                  <card_type ctype_of="heart"/>
                </yes>
                <not>
                  <card_type ctype_of="any"/>
                </not>       
              </case>
            </card>
            <card>
            <card>
              <case player_has_cards_of_ctype="spade">
                <yes>
                  <card_type ctype_of="spade"/>
                </yes>
                <not>
                  <card_type ctype_of="any"/>
                </not>       
              </case>
            </card>
             
          </following_cards>
        </not> 
      </case>  
    </leading>

    <leading pattern_name="shuai">
      <following_cards cards=":(get_cards_of_ctype_as(cards[0], count_of(cards), any_ctype)"/>
    </leading>

  </following>

  <!--玩家-->
  <players>
    <player_role name="defender" text="defender"/>
    <player_role name="attacter" text="attacter"/>

    <player_attr name="level" value_type="int"/>
    <player_attr name="IsMainPlayer" value_type="bool"/>
    <player_attr name="IsAttacter" value_type="bool"/>
    <player_attr name="IsDefender" value_type="bool"/>
    <player_attr name="sum_score" value_type="int"/>
    <player_attr name="Score" value_type="int"/>
    <player_attr name="IsTrickWinner" value_type="bool">
    <min>4</min>
    <max>4</max>
  
  </players>

  <!--一圈-->
  <trick>
    <!-- <cards_power decided_by="least_power_card"/> -->

    <!--通常情况下是出最大牌的player-->
    <winner test_greatest_power="true">
    </winner>

    <end>
      <!--进攻方赢，得到分数牌, cards，一圈打出的牌-->
      <conditions>
        <cases>
          <case testee="cards" cards_contain_cfigure_as=":(score_card)"/>
          <case>
            <!--Key string -->
            <trick_winner property="IsAttacter" ret_is="true"/>
          </case>
        </cases>

        <update>
          <find_player property="IsAttacter" ret_is="true"> 
            <update property="score" operation="add" value="card_score"/>
          </find_player>  
        </update>
      </conditions>

        <!---最后圈输赢测试 如果attacter win, attacter将获得底牌的分数--->
      <conditions>
        <cases>
          <case>
            <trick_winner value=":(player_cards_count_in_hand)" ret_is="0"/>
          </case>
          <case>
            <trick_winner property="IsAttacter" ret_is="true"/>
          </case>
        </cases>

        <update>
          <find_player property="IsAttacter" ret_is="true"> 
            <update property="score" operation="add" value=":(cards_in_kitty|sum_score)"/>
          </find_player>  
        </update>
      </conditions>
    </end>
  </trick>

  <!--局的赢家-->
  <round_winners>
    <!--确定输赢方-->
    <find_player property="IsAttacter" ret_is="true">
      <!--进攻方分数为0，防守方赢，升2级-->
      <case property="Score" ret_is="0">
        <set_winners>
          <find_player property="IsDefender" ret_is="true"/>
        </set_winnrs>
        <set_losers>
          <find_player property="IsAttacter" ret_is="true"/>
        </set_losers>
        <find_player property="IsDefender" ret_is="true"/>
          <update property="level" operation="inc" value="2"/>
        </find_player>

         <!--防守方赢，主打换人-->
        <find_player>
          <cases>
            <case property="IsDefender" ret_is="true"/>
            <case property="IsMainPlayer" ret_is="true"/>
          </cases>
         
          <update property="IsMainPlayer" value="false"/>
        </find_player>
        <find_player>
          <cases>
            <case property="IsDefender" ret_is="true"/>
            <case property="IsMainPlayer" ret_is="false"/>
          </cases>
          <update property="IsMainPlayer" value="true"/>
        </find_player>
      </case>
      <!--进攻方没分数<40，防守方赢，升一级-->
      <case property="Score" ret_lt="40">
        <set_winners>
          <find_player property="IsDefender" ret_is="true"/>
        </set_winnrs>
        <set_losers>
          <find_player property="IsAttacter" ret_is="true"/>
        </set_losers>
        <find_player property="IsDefender" ret_is="true">
          <update property="level" operation="inc" value="1"/>
        </find_player>

        <find_player>
          <cases>
            <case property="IsDefender" ret_is="true"/>
            <case property="IsMainPlayer" ret_is="true"/>
          </cases>
          <update property="IsMainPlayer" value="false"/>
        </find_player>
        <find_player>
          <cases>
            <case property="IsDefender" ret_is="true"/>
            <case property="IsMainPlayer" ret_is="false"/>
          </cases>
          <update property="IsMainPlayer" value="true"/>
        </find_player>
      </case>

      <!--进攻方分数40<x<80，进攻方赢，升一级-->
      <case property="Score" ret_lt="80">
        <winners>
          <find_player property="IsAttacter" ret_is="true"/>
        </winnrs>
        <losers>
          <find_player property="IsDefender" ret_is="true"/>
        </losers>
        <find_player property="IsAttacter" ret_is="true">
          <update property="level" operation="inc" value="1"/>
        </find_player>
        

        <block>
          <!--进攻方赢，攻守角色互换，本轮主打的下家为主打（主防守）-->
          <block>
            <find_player var="p1" property="IsMainPlayer" ret_is="true">
            </find_player>
            <find_player var="p2" property="seatid" ret_as=":(p1.seatid+1)">         
            </find_player>
          </block>
          <find_player var="p3" property="IsDefender" ret_is="true">        
          </find_player>
          <find_player var="p4" property="IsAttacter" ret_is="true">           
          </find_player>
          <updates>
            <players var="p2">
              <update property="IsMainPlayer" value="true">
            </players>
            <players var="p3">
              <update property="IsDefender" value="false"/>
              <update property="IsAttacter" value="true"/>
            </players>
            <players var="p4">
              <update property="IsDefender" value="true"/>
              <update property="IsAttacter" value="false"/>  
            </players>
          </updates>
        </block>


      </case>

      <!--进攻方分数>80，进攻方赢，升2级-->
      <case property="Score" ret_gt="80">
        <set_winners>
          <find_player property="IsAttacter" ret_is="true"/>
        </set_winnrs>
        <set_losers>
          <find_player property="IsDefender" ret_is="true"/>
        </set_losers>
        <find_player property="IsAttacter" ret_is="true">
          <update property="level" operation="inc" value="2"/>
        </find_player>

        <!--进攻方赢，攻守角色互换，本轮主打的下家为主打（主防守）-->
        <block>
          <!--进攻方赢，攻守角色互换，本轮主打的下家为主打（主防守）-->
          <block>
            <find_player var="p1" property="IsMainPlayer" ret_is="true">
            </find_player>
            <find_player var="p2" property="seatid" ret_as=":(p1.seatid+1)">         
            </find_player>
          </block>
          <find_player var="p3" property="IsDefender" ret_is="true">        
          </find_player>
          <find_player var="p4" property="IsAttacter" ret_is="true">           
          </find_player>
          <updates>
            <players var="p2">
              <update property="IsMainPlayer" value="true">
            </players>
            <players var="p3">
              <update property="IsDefender" value="false"/>
              <update property="IsAttacter" value="true"/>
            </players>
            <players var="p4">
              <update property="IsDefender" value="true"/>
              <update property="IsAttacter" value="false"/>  
            </players>
          </updates>
        </block>

      </case>
    </find_player>

    <!--一轮结束，更新各玩家状态-->
  </round_winners>

  <running>

    <!--发牌（摸牌，起牌）-->
    <!--每次一张牌-->
    <dealcard_loop start_player=":(init_player)" card_number_per_time="1">
    <!--底牌6张-->
      <case  cards_count_not_deal="6">
        <stoploop/>
      </case>

      <!--摸到将牌，可以叫主，前提是还没主-->
      <case testee="card" cfigure_of="card" ret_as=":(cur_level)">
        <case testee="round" property="bank_ctype" ret_is="none">
           <actions timeout_seconds="30" timeout_def_act="pass" to_player="pp" wait_until_player_response="true"> 
            <action act_ref="jiaozhu"/>
            <action act_ref="pass"/>
          </actions>
        </case>
      </case>
    </dealcard_loop>

    <!--发牌结束，必须有防守方，否则流局，此情况只发生刚开始的几局-->
    <continue_must_test>
      <case testee="round" property="defenders" ret_is="none">
        <action act_ref="liuju"/>
      </case>
    </continue_must_test>

    <!--底牌归于主打-->
    <find_player roperty="IsMainPlayer" ret_is="true">
      <deal_table_cards/>
    </find_player>

    <!--等待主打扣牌-->
    <find_player property="IsMainPlayer" ret_is="true">
      <actions timeout_seconds="30" timeout_def_act="force_koupai" wait_until_player_response="true" >
        <action act_ref="koupai"/>
        <action act_ref="force_koupai"/>
      </actions>
    </find_player>


    <!--进入打牌，从主打开始-->
    <playcard_loop>
      <block>
        <find_player var="p1" property="IsMainPlayer" ret_is="true">
          <actions timeout_seconds="30" timeout_def_act="force_chupai" wait_until_player_response="true">
            <action act_ref="playcard"/>
            <action act_ref="force_chupai"/>
          </actions>
        </find_player>
        <wait_play_cards/>
        <test_valid_leading/>
        <loop_for i_range="1,2,3">
          <find_player property="seatid" ret_as=":(p1.seatid+(:(i)))">
              <actions timeout_seconds="30" timeout_def_act="force_chupai" wait_until_player_response="true">
                <action act_ref="playcard"/>
                <action act_ref="force_chupai"/>
              </actions>
          </find_player>
          <wait_play_cards/>
        </loop_for>

        <!--一局结束，主打手里没牌-->
        <case>
          <find_player property="IsMainPlayer" ret_is="true">
            <case property=":(cards_count_in_player_hand)" ret_is="0">
              <stoploop/>
            </case>
          </find_player>
        </case>
      </block>
    </playcard_loop>
  
    <!--出牌结束，确定一局输赢玩家-->
    <tell_round_winners/>

    <!--广播一局胜负-->
    <publish_round_winners_losers/>

    <!--广播累积胜负-->
    <publish_total_scores/>
  </running>

  <!--玩家操作命令列表-->
  <actions>
    <!--叫主-->
    <action name="jiaozhu">
      <!-- <consequences for_round0="1"></consequences>
      <consequences for_roundX="1"></consequences> -->
      <update_round property="jiangpai" value="card">
      </update_round>
      <update_card_power>
        <cards_of_type operation="add" value="+20">
        <exe_card power="45">
        <cards_of_figure power="40">
      </update_card_power>

    </action>
    <action name="liuju">
      <finish_round/>
      <publish_players message=""/>
      <new_round/>
    </action>

    <!-- <aciton name="peng" text="peng">
      <update_round property="next_player" value="act_exe_player"/>
    </action> -->

    <action name="pass" text="pass">
      <consequences></consequences>
    </action>>
    <action name="koupai" text="koupai">
    </action>
    <action name="chupai" text="chupai">
    </action>
    <action name="force_chupai">
    </force_chupai>
    <action name="force_koupai" text="none" >
       <consequences>
         <consequences>
            <random_pick_cards number="6" as="di"/>
            <play_cards_to_table cards="di">
         </consequences>
       </consequences>
    </action>
  </actions>
</game>